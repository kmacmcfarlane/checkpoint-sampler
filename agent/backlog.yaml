schema_version: 2
project: checkpoint-sampler
defaults:
  priority_order: "higher_is_more_important"
  status_field: "status"
  blocked_field: "blocked"
  blocked_reason_field: "blocked_reason"
  review_feedback_field: "review_feedback"
  requires_field: "requires"

# ─── SETUP ───────────────────────────────────────────────────────────────────

stories:
  - id: S-001
    title: "Architecture and schema documentation"
    priority: 100
    status: done
    requires: []
    acceptance:
      - "docs/architecture.md reflects checkpoint-sampler system (filesystem scanning, image serving, WebSocket, SQLite)"
      - "docs/database.md documents the presets table schema"
      - "docs/api.md documents the REST and WebSocket API surface"
      - "CLAUDE.md section 5 updated to reference SQLite + TOML config"
    testing:
      - "command: (n/a) documentation only"

  - id: S-002
    title: "TOML configuration loading"
    priority: 95
    status: done
    requires: []
    acceptance:
      - "Backend reads config.toml at startup (path overridable via CONFIG_PATH env var)"
      - "Config struct covers: root (no files below this dir should be accessed, validation error if it does not exist), port (webUI), ip_address (default 127.0.0.1 but can be set to 0.0.0.0 for external access), db_path (default to ./data/), training_runs (regex path patterns that match below the root)"
      - "Validation rejects missing root, invalid regex patterns, invalid port, invalid ip address, or db_path"
      - "Unit tests cover valid config, missing fields, invalid regex"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-003
    title: "SQLite database setup and migrations"
    priority: 90
    status: done
    requires: [S-002]
    acceptance:
      - "SQLite database created at configured db_path with WAL mode, busy timeout, foreign keys"
      - "Forward-only migration system with schema_migrations tracking table"
      - "Initial migration creates presets table (id, name, mapping JSON, created_at, updated_at)"
      - "Store layer exposes interface consumed by service layer"
      - "Unit tests cover migration execution and idempotency"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-004
    title: "Goa API scaffold and codegen pipeline"
    priority: 85
    status: done
    requires: [S-002]
    acceptance:
      - "Goa DSL defines health and docs services"
      - "make gen produces generated code under internal/api/gen"
      - "Swagger UI served at /docs with OpenAPI 3.0 spec"
      - "Server starts and responds to health check"
      - "CORS configured for frontend origin"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-005
    title: "Frontend scaffold and API client"
    priority: 80
    status: done
    requires: []
    acceptance:
      - "Vue 3 app with TypeScript strict, Composition API, Vite dev server"
      - "API client module in src/api/ with typed fetch wrapper"
      - "Error normalization in the API client layer"
      - "App shell renders with placeholder content"
      - "Unit test infrastructure working (vitest)"
    testing:
      - "command: npx vitest run"

  - id: S-006
    title: "Docker Compose and Makefile wiring"
    priority: 75
    status: done
    requires: [S-004, S-005]
    acceptance:
      - "docker-compose.yml mounts dataset root as read-only volume into backend container"
      - "docker-compose.yml mounts SQLite data directory as read-write volume"
      - "make up launches production build; both containers start and respond"
      - "make up-dev launches hot-reload mode (air + Vite HMR)"
      - "Backend binds 0.0.0.0 for LAN access"
      - "Frontend proxies API requests to backend"
    testing:
      - "command: make up (verify containers start and respond)"

# ─── FEATURES (end-to-end) ───────────────────────────────────────────────────

  - id: S-007
    title: "Training run listing and selection"
    priority: 70
    status: done
    requires: [S-004, S-005, S-006]
    acceptance:
      - "BE: GET /api/training-runs returns all training runs from config (name, pattern, dimensions)"
      - "BE: Goa DSL defines training_runs service and list method"
      - "BE: Unit tests for the training runs endpoint"
      - "FE: TrainingRunSelector component renders a dropdown of training runs from the API"
      - "FE: Selecting a training run stores it in app state"
      - "FE: Unit tests for TrainingRunSelector and API client method"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

  - id: S-008
    title: "Filesystem scanning and image serving (backend)"
    priority: 65
    status: done
    requires: [S-007]
    acceptance:
      - "Service layer: given a training run config, find all directories under root matching the pattern"
      - "Service layer: scan matching directories for .png files"
      - "Service layer: parse query-encoded filenames into dimension key-value pairs"
      - "Service layer: ignore _NNNNN_ batch suffix; use highest batch number when duplicates exist"
      - "Service layer: apply directory dimension extraction regexes"
      - "Service layer: return list of images with dimensions, and list of all discovered dimensions with unique values"
      - "API: GET /api/training-runs/{id}/scan triggers scan and returns results"
      - "API: GET /api/images/*filepath serves image files with path traversal protection"
      - "API: image responses include Cache-Control: max-age=31536000, immutable"
      - "All filesystem access validated to stay within configured root"
      - "Unit tests: filename parsing, batch dedup, directory regex extraction, path traversal rejection, image serving"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-009
    title: "X/Y grid with dimension mapping"
    priority: 60
    status: done
    requires: [S-008]
    acceptance:
      - "FE: DimensionPanel component lists all discovered dimensions from scan results"
      - "FE: Each dimension can be assigned to exactly one role: X, Y, slider, or combo"
      - "FE: XYGrid component renders rows (Y values) and columns (X values)"
      - "FE: ImageCell displays the matching image at full resolution (1344x1344 source)"
      - "FE: Missing X/Y combinations show an empty placeholder cell"
      - "FE: Grid scrolls horizontally and vertically as needed"
      - "FE: Changing dimension assignments re-renders the grid immediately"
      - "FE: Unit tests for DimensionPanel, XYGrid, and ImageCell"
    testing:
      - "command: npx vitest run"

  - id: S-010
    title: "Combo filters"
    priority: 55
    status: done
    requires: [S-009]
    acceptance:
      - "FE: ComboFilter component for each combo-assigned dimension"
      - "FE: Dropdown populated with all discovered values for that dimension"
      - "FE: Multi-select via checkboxes"
      - "FE: Click value label for single-selection shortcut"
      - "FE: Select-all / select-none control on each combo"
      - "FE: Filtering is cumulative across all combos and updates the grid"
      - "FE: Unit tests for ComboFilter"
    testing:
      - "command: npx vitest run"

  - id: S-011
    title: "Slider navigation"
    priority: 50
    status: done
    requires: [S-009]
    acceptance:
      - "FE: Each ImageCell has an individual SliderBar cycling through slider-dimension values"
      - "FE: MasterSlider at the top moves all individual sliders in sync"
      - "FE: Moving a slider swaps the displayed image in that cell"
      - "FE: Pre-caching priority: (1) all slider positions for visible grid cells, then (2) remaining scan images in background"
      - "FE: Unit tests for SliderBar and MasterSlider"
    testing:
      - "command: npx vitest run"

  - id: S-012
    title: "Preset save and select"
    priority: 45
    status: done
    requires: [S-003, S-009]
    acceptance:
      - "BE: Goa DSL defines presets service with list, create, update, delete methods"
      - "BE: Presets CRUD wired through service layer to SQLite store"
      - "BE: List returns all presets"
      - "BE: Unit tests for presets service and store"
      - "FE: PresetSelector component with dropdown of saved presets"
      - "FE: Save button prompts for a name and creates a preset via API"
      - "FE: Selecting a preset loads its mapping and re-renders the grid; unmatched dimensions show a warning"
      - "FE: Delete option on each preset"
      - "FE: Unit tests for PresetSelector"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

  - id: S-018
    title: "Auto-discover training runs from checkpoint files"
    priority: 43
    status: done
    requires: [S-007, S-008]
    acceptance:
      - "BE: Switch config from TOML to YAML (config.yaml); remove [[training_runs]] and [[training_runs.dimensions]] from config parsing"
      - "BE: Create a config.yaml.example with generic values, but create a config.yaml (gitignored) that has values for me (/home/rt/ai/models-training/stable-diffusion/checkpoints for the models dir and /home/rt/ai/outputs/stable-diffusion/comfyui/checkpoint-sampler for the samples dir)"
      - "BE: Config struct has checkpoint_dirs (list of strings), sample_dir (string), port, db_path"
      - "BE: Validation rejects missing checkpoint_dirs, missing sample_dir, non-existent directories"
      - "BE: Discovery service recursively scans all checkpoint_dirs for .safetensors files"
      - "BE: Group checkpoint files into training runs by stripping suffixes: .safetensors extension, -step<NNNNN> suffix, -<NNNNNN> epoch suffix"
      - "BE: For each checkpoint file, look up matching sample directory under sample_dir (exact filename match); set has_samples flag"
      - "BE: Auto-extract checkpoint step/epoch number as a 'checkpoint' dimension (sorted numerically); final checkpoint (no suffix) assigned max step value if detectable, otherwise sorted last"
      - "BE: GET /api/training-runs returns auto-discovered training runs with checkpoint counts and has_samples info; supports ?has_samples=true filter"
      - "BE: GET /api/training-runs/{id}/scan scans sample directories for the training run's checkpoints, producing filename dimensions plus the auto-extracted checkpoint dimension"
      - "BE: Unit tests for config YAML parsing, directory scanning, suffix stripping, grouping, sample correlation, checkpoint dimension extraction"
      - "FE: TrainingRunSelector shows auto-discovered runs with a default-checked 'Has samples' filter checkbox"
      - "FE: Unit tests for the has-samples filter behavior"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

  - id: B-001
    title: "WAL mode fails with read-only dev volume"
    priority: 42
    status: done
    requires: [S-003]
    acceptance:
      - "make up-dev starts without 'attempt to write a readonly database' error on PRAGMA journal_mode=WAL"
      - "SQLite database is writable in both make up and make up-dev modes"
    testing:
      - "command: make up-dev (verify backend starts without WAL error)"

  - id: B-002
    title: "No config.yaml content"
    priority: 42
    status: done
    requires: [S-003]
    acceptance:
      - "BE: Create a config.yaml.example with generic values, but create a config.yaml (gitignored) that has values for me (/home/rt/ai/models-training/stable-diffusion/checkpoints for the models dir and /home/rt/ai/outputs/stable-diffusion/comfyui/checkpoint-sampler for the samples dir)"
      - "Updated README.md so other people know to copy and customize the config.yaml"
    testing:
      - "command: make up-dev (verify backend starts without error)"

  - id: B-003
    title: "Dimension UI selection"
    priority: 42
    status: done
    requires: [S-003]
    acceptance:
      - "FE: When a dimension in a combo box, you can select which values are enabled. If you disable a value, then change that dimension to be the X/Y/Slider, then you lose the ability to see those images."
      - "FE: Always show the combo selectors even when the dimension is assigned to X/Y/Slider"
      - "FE: Change label from 'combo filter' to 'none' since we always show combos"
      - "BE: Make sure the value for the formerly 'combo filter' selection still makes sense as 'none' (it should have a null value to show it's unassigned I imagine)"
    testing:
      - "command: make up-dev (verify backend starts without error)"

  - id: R-001
    title: "Refactor Goa HTTP wireup into NewHTTPHandler"
    priority: 41
    status: done
    requires: [S-004]
    acceptance:
      - "BE: Extract all Goa HTTP transport setup from main.go into NewHTTPHandler() in internal/api/http.go"
      - "BE: NewHTTPHandler takes pre-built *<service>.Endpoints, logger, and debug flag; returns http.Handler"
      - "BE: Mux creation, decoder/encoder, server instantiation, mounting, and mount logging all live inside NewHTTPHandler"
      - "BE: errorHandler helper function in internal/api/http.go logs errors with request ID for correlation"
      - "BE: HTTP-level middleware (RequestID, CORS) applied inside NewHTTPHandler"
      - "BE: main.go only owns dependency injection: config, stores, services, API impls, endpoint creation"
      - "BE: main.go calls NewHTTPHandler and receives http.Handler; wires it into http.Server"
      - "BE: Custom image handler and /docs redirect mounted inside NewHTTPHandler"
      - "BE: All existing tests pass unchanged"
      - "BE: Server starts and all endpoints respond identically to before"
    testing:
      - "command: make test-backend"

  - id: S-013
    title: "Image lightbox with zoom and pan"
    priority: 40
    status: done
    requires: [S-009]
    acceptance:
      - "FE: Clicking an image cell opens ImageLightbox modal overlay"
      - "FE: Mouse wheel zooms in/out"
      - "FE: Click-drag pans the zoomed image"
      - "FE: Escape or clicking outside closes the overlay or pressing the esc key"
      - "FE: Unit tests for ImageLightbox"
    testing:
      - "command: npx vitest run"

  - id: S-014
    title: "WebSocket live updates (backend)"
    priority: 35
    status: done
    requires: [S-008]
    acceptance:
      - "BE: WebSocket hub manages connected clients"
      - "BE: fsnotify watches directories belonging to the active training run"
      - "BE: New/changed/removed image files produce JSON events pushed to clients"
      - "BE: Event types: image_added, image_removed, directory_added"
      - "BE: Goa DSL defines ws service with WebSocket upgrade endpoint"
      - "BE: Unit tests for WebSocket hub and filesystem watcher"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-015
    title: "WebSocket live updates (frontend)"
    priority: 30
    status: done
    requires: [S-009, S-014]
    acceptance:
      - "FE: WebSocket client in src/api/ connects to /api/ws"
      - "FE: Auto-reconnects on disconnect with backoff"
      - "FE: Incoming events update dimension values and grid cells without full reload"
      - "FE: Unit tests for WebSocket client and reconnection logic"
    testing:
      - "command: npx vitest run"

# ─── ENHANCEMENTS ─────────────────────────────────────────────────────────────

  - id: S-016
    title: "Keyboard navigation for sliders"
    priority: 20
    status: done
    requires: [S-011]
    acceptance:
      - "FE: Arrow keys (left/right) step through slider values when a grid cell or slider is focused"
      - "FE: Keyboard interaction works for both individual cell sliders and the master slider"
      - "FE: Unit tests for keyboard navigation behavior"
    testing:
      - "command: npx vitest run"

  - id: S-017
    title: "Slider playback mode"
    priority: 15
    status: done
    requires: [S-011]
    acceptance:
      - "FE: Play/pause button on the master slider that auto-advances through values at a configurable interval"
      - "FE: Playback stops when reaching the last value (or optionally loops)"
      - "FE: User can adjust playback speed"
      - "FE: Unit tests for playback logic (start, stop, interval, loop)"
    testing:
      - "command: npx vitest run"

  - id: S-019
    title: "Checkpoint metadata slideout panel"
    priority: 12
    status: done
    requires: [S-018]
    acceptance:
      - "BE: Parse safetensors file headers to extract ss_* metadata fields (output_name, total_steps, epochs, optimizer, dataset, base_model, etc.)"
      - "BE: GET /api/checkpoints/{filename}/metadata returns parsed metadata as JSON; filename is resolved against checkpoint_dirs"
      - "BE: Validate filename stays within checkpoint_dirs (path traversal protection)"
      - "BE: Return empty metadata object (not error) when no ss_* fields present"
      - "BE: Unit tests for safetensors header parsing, path validation, missing metadata"
      - "FE: CheckpointMetadataPanel slideout component with checkpoint list for the current training run"
      - "FE: Highest step count checkpoint selected by default"
      - "FE: Selecting a checkpoint fetches and displays its metadata from the API"
      - "FE: Show 'no metadata available' when checkpoint has no ss_* fields"
      - "FE: Slideout opens/closes without affecting grid state"
      - "FE: Unit tests for CheckpointMetadataPanel"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

  - id: S-020
    title: "Generation metadata in image lightbox"
    priority: 10
    status: done
    requires: [S-013, S-018]
    acceptance:
      - "BE: Parse PNG tEXt chunks to extract ComfyUI Prompt and Workflow metadata"
      - "BE: GET /api/images/*/metadata returns raw embedded JSON metadata for the image"
      - "BE: Validate image path stays within sample_dir (path traversal protection)"
      - "BE: Return empty metadata object (not error) when PNG has no embedded metadata"
      - "BE: Unit tests for PNG metadata extraction, path validation, missing metadata"
      - "FE: ImageLightbox shows a metadata section with the raw ComfyUI workflow JSON"
      - "FE: Metadata fetched on-the-fly when lightbox opens (not pre-loaded)"
      - "FE: JSON displayed in scrollable, formatted view"
      - "FE: Show 'no metadata available' when PNG has no embedded metadata"
      - "FE: Metadata section does not interfere with zoom/pan functionality"
      - "FE: Unit tests for metadata display in lightbox"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

# ─── UI OVERHAUL ─────────────────────────────────────────────────────────────

  - id: R-002
    title: "Migrate to Naive UI component library"
    priority: 9
    status: done
    requires: []
    acceptance:
      - "FE: Install naive-ui as a dependency"
      - "FE: Set up NConfigProvider at the app root with theme support"
      - "FE: Convert all buttons to NButton"
      - "FE: Convert all selects/dropdowns to NSelect"
      - "FE: Convert all checkboxes to NCheckbox/NCheckboxGroup"
      - "FE: Convert range input sliders to NSlider"
      - "FE: Convert tables to NTable or NDataTable"
      - "FE: Convert the checkpoint metadata slideout to NDrawer"
      - "FE: Remove custom CSS that is now handled by Naive UI components"
      - "FE: All existing tests pass or are updated for Naive UI component wrappers"
      - "FE: Application renders and functions identically to before (no visual regressions beyond component library styling)"
    testing:
      - "command: npx vitest run"

  - id: S-021
    title: "Dark/Light theme toggle"
    priority: 8
    status: done
    requires: [R-002]
    acceptance:
      - "FE: 2-way theme toggle (Light/Dark) in the application header"
      - "FE: Default theme determined by browser prefers-color-scheme media query"
      - "FE: Selected theme persisted in localStorage"
      - "FE: NConfigProvider theme prop wired to selected theme"
      - "FE: All Naive UI components render correctly in both themes"
      - "FE: Any remaining custom styles respect the active theme (no hardcoded colors)"
      - "FE: Unit tests for theme toggle, persistence, and system default detection"
    testing:
      - "command: npx vitest run"

  - id: S-022
    title: "Left-side slide-out controls panel"
    priority: 7
    status: done
    requires: [R-002]
    acceptance:
      - "FE: NDrawer component opens from the left in overlay mode (does not push main content)"
      - "FE: Drawer contains (top to bottom): Training Run Picker, Preset Picker, Dimension Assignments"
      - "FE: Hamburger toggle button in the header opens/closes the drawer"
      - "FE: Drawer open by default on wide screens (>=1024px), closed on narrow screens"
      - "FE: Drawer does not affect grid state when opened/closed"
      - "FE: TrainingRunSelector and PresetSelector removed from header, moved into drawer"
      - "FE: Unit tests for drawer toggle behavior and responsive default state"
    testing:
      - "command: npx vitest run"

  - id: S-023
    title: "Dimension filter modes (Hide/Single/Multi)"
    priority: 6
    status: done
    requires: [R-002]
    acceptance:
      - "FE: Each dimension has a filter mode selector: Hide, Single, Multi"
      - "FE: Hide mode: no filter UI rendered for that dimension; all values included"
      - "FE: Single mode: NSelect or NRadioGroup allowing exactly one value at a time"
      - "FE: Multi mode: NCheckboxGroup with solo/unsolo label click behavior"
      - "FE: Multi solo: click a value label to select only that value"
      - "FE: Multi unsolo: click the only-selected label to re-select all values"
      - "FE: Dimensions assigned to X/Y/Slider always use Multi filter mode (implicit)"
      - "FE: Unassigned dimensions default to Hide filter mode"
      - "FE: Switching from Multi to Single defaults to first previously-selected value, or first value"
      - "FE: Dimension filters in main content area are collapsed by default with expand/collapse toggle"
      - "FE: Filtering is cumulative across all visible dimension filters"
      - "FE: Unit tests for all three filter modes, mode switching, solo/unsolo, collapse behavior"
    testing:
      - "command: npx vitest run"

  - id: S-024
    title: "X/Y grid improvements"
    priority: 5
    status: done
    requires: [R-002, S-023]
    acceptance:
      - "FE: Remove independent grid overflow; the entire page scrolls together (no max-height or overflow:auto on grid container)"
      - "FE: Grid uses the full viewport width and height, minus a spacer for the sticky master slider at the top"
      - "FE: Grid cell boundaries resizable by dragging dividers between cells"
      - "FE: Vertical (column) dividers: all column widths change together when dragged"
      - "FE: Horizontal (row) dividers: all row heights change together when dragged"
      - "FE: Click an X column header to solo that value in the X dimension's Multi filter"
      - "FE: Click a soloed X header to re-select all values for that dimension"
      - "FE: Same solo/unsolo behavior for Y row headers"
      - "FE: Unit tests for header click filtering, resize behavior, and scroll changes"
    testing:
      - "command: npx vitest run"

  - id: S-025
    title: "Main slider layout improvements"
    priority: 4
    status: done
    requires: [R-002]
    acceptance:
      - "FE: Master slider is 100% width of the main content area"
      - "FE: Master slider is always visible: position sticky at top of viewport so it stays accessible when grid overflows"
      - "FE: Play button inline with the slider (stacks vertically on small mobile)"
      - "FE: Pressing Play starts playback and reveals loop controls (loop checkbox + speed selector)"
      - "FE: Stopping playback hides loop controls"
      - "FE: Loop enabled by default"
      - "FE: Speed options: 0.25s, 0.33s, 0.5s, 1s (default), 2s, 3s"
      - "FE: Unit tests for play/stop visibility toggle, default loop state, new speed options"
    testing:
      - "command: npx vitest run"

  - id: B-004
    title: "Lightbox backdrop close broken and missing close button"
    priority: 3
    status: done
    requires: [R-002]
    acceptance:
      - "FE: Fix backdrop click (clicking outside the image) to close the lightbox"
      - "FE: Add an X button in the top-left corner to close the lightbox"
      - "FE: Escape key continues to close the lightbox"
      - "FE: Unit tests for backdrop close, X button close, and Escape close"
    testing:
      - "command: npx vitest run"

  - id: S-026
    title: "Checkpoint metadata panel improvements"
    priority: 2
    status: done
    requires: [R-002]
    acceptance:
      - "FE: Slideout panel resizable by dragging its left edge"
      - "FE: Min width 300px, max width 80vw"
      - "FE: Full width at the smallest responsive breakpoint (<768px)"
      - "FE: Stacked key-value layout: key displayed as header above value (not side-by-side table)"
      - "FE: Unit tests for resize constraints and stacked layout rendering"
    testing:
      - "command: npx vitest run"

  - id: B-005
    title: "X/Y grid layout breaks with different configurations"
    priority: 3
    status: done
    requires: [S-024]
    acceptance:
      - "FE: Replace flexbox grid layout with CSS Grid so cells align correctly regardless of content or configuration"
      - "FE: Grid must maintain consistent column widths and row heights across all rows/columns"
      - "FE: Empty/placeholder cells must not collapse or shift adjacent cells"
      - "FE: Grid renders correctly with varying numbers of X and Y values (1x1, 1xN, Nx1, NxM)"
      - "FE: Flat mode (no axes assigned) also uses consistent cell sizing"
      - "FE: Existing divider-based cell resizing continues to work with CSS Grid"
      - "FE: Unit tests for grid alignment with varying configurations"
    testing:
      - "command: npx vitest run"

  - id: B-006
    title: "No zoom/scale control for grid cell size"
    priority: 3
    status: done
    requires: [S-024]
    acceptance:
      - "FE: Add a zoom slider (or similar control) near the master slider area to scale grid cell size"
      - "FE: Zoom slider adjusts both cellWidth and cellHeight proportionally"
      - "FE: Zoom range covers useful sizes from thumbnail (~100px) to large (~600px)"
      - "FE: Zoom control is more discoverable than the current drag-divider approach"
      - "FE: Divider-based resizing may be kept as a secondary mechanism or removed"
      - "FE: Unit tests for zoom slider controlling cell dimensions"
    testing:
      - "command: npx vitest run"

  - id: S-027
    title: "Responsive design polish"
    priority: 1
    status: done
    requires: [R-002, S-021, S-022, S-023, S-024, S-025, B-004, S-026]
    acceptance:
      - "FE: All UI elements render correctly at mobile (<768px), tablet (768-1023px), and desktop (>=1024px) breakpoints"
      - "FE: Left drawer responsive default verified at all breakpoints"
      - "FE: Master slider stacks controls vertically at mobile breakpoint"
      - "FE: Checkpoint metadata panel full width at mobile breakpoint"
      - "FE: Dimension filters render appropriately at all breakpoints"
      - "FE: No horizontal overflow at any breakpoint (single scrollable page)"
      - "FE: Unit tests for responsive behavior where applicable"
    testing:
      - "command: npx vitest run"

# ─── NEW BUGS & ENHANCEMENTS ──────────────────────────────────────────────────

  - id: B-007
    title: "Checkpoint metadata panel dark mode text unreadable"
    priority: 3
    status: done
    requires: [S-026, S-021]
    acceptance:
      - "FE: Metadata value text color is readable in dark mode (uses theme-aware color tokens, not hardcoded colors)"
      - "FE: Values are clearly legible against the dark background in both light and dark themes"
      - "FE: Unit tests verify metadata values render with correct theme-aware styling"
    testing:
      - "command: npx vitest run"

  - id: B-008
    title: "Checkpoint selector in metadata slideout has unreadable background"
    priority: 3
    status: done
    requires: [S-026, S-021]
    acceptance:
      - "FE: Checkpoint selector dropdown in the metadata slideout uses theme-appropriate background and text colors"
      - "FE: Checkpoint names are clearly readable in both light and dark themes"
      - "FE: Unit tests verify selector styling respects active theme"
    testing:
      - "command: npx vitest run"

  - id: S-028
    title: "XY grid corner-based cell resizing"
    priority: 3
    status: done
    requires: [S-024]
    acceptance:
      - "FE: Grid cells can be resized by dragging corner handles (adjusts both width and height simultaneously)"
      - "FE: Corner resize replaces or supplements the existing vertical/horizontal divider approach"
      - "FE: Resize maintains aspect ratio or allows freeform (user preference)"
      - "FE: All cells resize together (uniform grid sizing)"
      - "FE: Unit tests for corner-based resize behavior"
    testing:
      - "command: npx vitest run"

  - id: B-009
    title: "XY grid header solo click should hide non-selected values from grid"
    priority: 3
    status: done
    requires: [S-024]
    acceptance:
      - "FE: Clicking an X column header hides all other columns from the grid (not just highlights)"
      - "FE: Clicking a Y row header hides all other rows from the grid"
      - "FE: Clicking the soloed header again restores all values"
      - "FE: Grid re-renders with only the selected row/column visible after header solo click"
      - "FE: Unit tests for header solo filtering grid visibility"
    testing:
      - "command: npx vitest run"

  - id: S-029
    title: "Collapse all dimension filters into single expandable 'Filters' section"
    priority: 3
    status: done
    requires: [S-023]
    acceptance:
      - "FE: Replace individual dimension filter expand/collapse toggles with a single 'Filters' arrow/header"
      - "FE: Clicking 'Filters' expands to show all dimension filters; clicking again collapses all"
      - "FE: Collapsed by default"
      - "FE: Unit tests for expand/collapse behavior of the unified filters section"
    testing:
      - "command: npx vitest run"

  - id: B-010
    title: "WebSocket live updates always displays 'disconnected'"
    priority: 3
    status: done
    requires: [S-015]
    acceptance:
      - "FE: WebSocket connection status indicator shows 'connected' when actually connected"
      - "FE: Investigate and fix why the status always shows 'disconnected' (connection failure, incorrect status tracking, or display bug)"
      - "FE: Status indicator accurately reflects the real connection state at all times"
      - "FE: Unit tests for connection status display accuracy"
    testing:
      - "command: npx vitest run"

  - id: B-011
    title: "Auto-load previously used dimension preset from localStorage"
    priority: 3
    status: done
    requires: [S-012]
    acceptance:
      - "FE: When a preset is selected, persist the preset ID (and training run ID) in localStorage"
      - "FE: On app load, if a saved preset exists in localStorage, auto-select that training run and apply the preset"
      - "FE: Gracefully handle stale/deleted presets (clear localStorage entry and fall back to no preset)"
      - "FE: Unit tests for persistence, auto-load on startup, and stale preset handling"
    testing:
      - "command: npx vitest run"

# ─── INFERENCE PIPELINE ────────────────────────────────────────────────────────

  - id: S-030
    title: "ComfyUI configuration, client, and model discovery"
    priority: -1
    status: todo
    requires: [S-002]
    acceptance:
      - "BE: Add comfyui.host (default localhost), comfyui.port (default 8188), and workflow_dir (default ./workflows) to config.yaml schema"
      - "BE: Config validation: comfyui section is optional; if present, host and port must be valid"
      - "BE: ComfyUI HTTP client: health check, submit prompt, get history, get queue status"
      - "BE: ComfyUI WebSocket client: connect and receive progress/execution events"
      - "BE: Model discovery: query /object_info/{node_type} for available VAEs (VAELoader), CLIPs (CLIPLoader), UNETs (UNETLoader), samplers, and schedulers"
      - "BE: Goa DSL: comfyui service with status and models endpoints"
      - "BE: API: GET /api/comfyui/status returns connection status"
      - "BE: API: GET /api/comfyui/models?type={vae|clip|unet|sampler|scheduler} returns available model names"
      - "BE: Unit tests for config parsing, ComfyUI client (mocked HTTP), model discovery parsing"
      - "FE: ComfyUI connection status indicator in the UI header showing online/offline state with colored dot or badge"
      - "FE: Status indicator polls /api/comfyui/status periodically and updates in real-time"
      - "FE: When comfyui config is absent, the indicator is hidden (inference features disabled)"
      - "FE: Unit tests for status indicator (online, offline, hidden states)"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

  - id: S-031
    title: "Workflow template management"
    priority: -2
    status: todo
    requires: [S-030]
    acceptance:
      - "BE: Load workflow JSON files from configured workflow_dir on startup"
      - "BE: Validate cs_role tags in _meta objects (required: save_image; known roles: unet_loader, clip_loader, vae_loader, sampler, positive_prompt, negative_prompt, shift, latent_image, save_image)"
      - "BE: Reject workflows missing save_image role; flag unknown cs_role values as warnings"
      - "BE: Extract role summary per workflow (which roles are present, which node IDs they map to)"
      - "BE: Goa DSL: workflows service with list and show methods"
      - "BE: API: GET /api/workflows returns list of available workflow templates with role summaries"
      - "BE: API: GET /api/workflows/{name} returns full workflow details including roles and validation status"
      - "BE: Create workflow_dir at startup if it does not exist"
      - "BE: Unit tests for loading, validation, role extraction, missing directory handling"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-032
    title: "Sample setting presets"
    priority: -3
    status: todo
    requires: [S-030, S-003]
    acceptance:
      - "BE: DB migration: create sample_presets table (id, name, prompts JSON, negative_prompt, steps JSON, cfgs JSON, samplers JSON, schedulers JSON, seeds JSON, width, height, created_at, updated_at)"
      - "BE: Sample preset service and store with CRUD operations"
      - "BE: Validation: at least one prompt, step, cfg, sampler, scheduler, and seed required; width/height must be positive"
      - "BE: Computed field images_per_checkpoint returned with each preset"
      - "BE: Goa DSL: sample_presets service with list, create, update, delete methods"
      - "BE: Unit tests for CRUD, validation, images_per_checkpoint calculation"
      - "FE: SamplePresetEditor component for creating/editing presets"
      - "FE: Multi-value inputs for prompts (name + text pairs), steps, CFG values, seeds"
      - "FE: Sampler and scheduler dropdowns populated from ComfyUI API (/api/comfyui/models?type=sampler|scheduler)"
      - "FE: Width and height inputs"
      - "FE: Negative prompt input"
      - "FE: Computed total images per checkpoint displayed prominently"
      - "FE: Save/load/edit/delete preset operations"
      - "FE: Unit tests for preset editor, computed total, CRUD operations"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."
      - "command: npx vitest run"

  - id: S-033
    title: "Sample job orchestration"
    priority: -4
    status: todo
    requires: [S-031, S-032]
    acceptance:
      - "BE: DB migration: create sample_jobs table (id, training_run_name, sample_preset_id, workflow_name, vae, clip, shift, status, total_items, completed_items, error_message, created_at, updated_at)"
      - "BE: DB migration: create sample_job_items table (id, job_id, checkpoint_filename, comfyui_model_path, prompt_name, prompt_text, steps, cfg, sampler_name, scheduler, seed, status, comfyui_prompt_id, output_path, error_message, created_at, updated_at)"
      - "BE: Job creation: expand sample preset parameters × training run checkpoints into individual work items"
      - "BE: Checkpoint-to-ComfyUI path matching: query ComfyUI for available UNETs, match by checkpoint filename"
      - "BE: Job state machine: pending → running → completed|failed|paused"
      - "BE: Progress computation: checkpoints_completed, current_checkpoint_progress, estimated_completion_time"
      - "BE: Goa DSL: sample_jobs service with create, list, show, stop, resume, delete methods"
      - "BE: API endpoints for all job operations"
      - "BE: Unit tests for job creation, item expansion, state transitions, progress calculation, path matching"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-034
    title: "Sample job execution engine"
    priority: -5
    status: todo
    requires: [S-033]
    acceptance:
      - "BE: Background job executor goroutine processes work items sequentially"
      - "BE: For each item: clone workflow template, substitute tagged node values (unet_loader, clip_loader, vae_loader, sampler params, prompts, shift, latent_image dimensions, save_image prefix)"
      - "BE: Submit parameterized workflow to ComfyUI via POST /prompt"
      - "BE: Monitor completion via ComfyUI WebSocket progress events"
      - "BE: On completion: download output image via ComfyUI /view API"
      - "BE: Save image to sample_dir/{checkpoint_filename}/{query_encoded_params}.png"
      - "BE: Query-encoded filename includes: prompt_name, steps, cfg, sampler_name, scheduler, seed"
      - "BE: Update job item status and job progress after each completion"
      - "BE: Push job progress events to frontend clients via existing WebSocket"
      - "BE: Stop: set job status to paused, cancel any queued ComfyUI prompt, stop after current item completes"
      - "BE: Resume: pick up from first incomplete item, set job status back to running"
      - "BE: Handle ComfyUI errors gracefully: mark item as failed, continue with next item"
      - "BE: Job survives application restart: on startup, resume any jobs in 'running' state"
      - "BE: Unit tests for workflow substitution, output filename generation, stop/resume logic, error handling"
    testing:
      - "command: ginkgo -r --cover --race ./internal/..."

  - id: S-035
    title: "Sample job launch and progress UI"
    priority: -6
    status: todo
    requires: [S-033, S-034]
    acceptance:
      - "FE: 'Generate Samples' button available on training runs (prominent for runs without samples)"
      - "FE: JobLaunchDialog: select workflow template from dropdown"
      - "FE: JobLaunchDialog: select sample setting preset from dropdown"
      - "FE: JobLaunchDialog: select VAE from ComfyUI-populated dropdown"
      - "FE: JobLaunchDialog: select CLIP/text encoder from ComfyUI-populated dropdown"
      - "FE: JobLaunchDialog: shift value input (hidden if workflow has no shift role)"
      - "FE: JobLaunchDialog: confirmation summary showing number of checkpoints, images per checkpoint, total images"
      - "FE: JobProgressPanel: list of active and recent jobs"
      - "FE: JobProgressPanel: per-job display — status badge, checkpoints completed/total, current checkpoint images completed/total, estimated completion time"
      - "FE: JobProgressPanel: stop button for running jobs, resume button for paused jobs"
      - "FE: Real-time progress updates via WebSocket"
      - "FE: As images complete, they appear in the grid via the existing filesystem watcher / live update mechanism"
      - "FE: Unit tests for launch dialog, progress display, stop/resume interactions"
    testing:
      - "command: npx vitest run"
