FROM golang:1.25-alpine

RUN apk add --no-cache gcc musl-dev make

RUN go install github.com/air-verse/air@latest && \
    go install github.com/onsi/ginkgo/v2/ginkgo@latest && \
    go install goa.design/goa/v3/cmd/goa@latest

# Make Go module cache and tooling readable by any user
RUN chmod -R a+rX /go

# Prepare writable cache dirs for non-root user
RUN mkdir -p /home/gouser/.cache/go-build /home/gouser/go/pkg/mod && chmod -R 777 /home/gouser

WORKDIR /app

# Create data directory writable by any user (for named volume mounts)
RUN mkdir -p /app/data && chmod 777 /app/data

RUN mkdir -p /app/backend
COPY go.mod go.sum ./backend/
RUN cd /app/backend && go mod download

EXPOSE 8080
CMD ["sh", "-c", "cd backend && go generate ./internal/api/... && air -c .air.toml"]
